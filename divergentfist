-- ==========================================
-- DIVERGENT FIST (SERVER SPIN + CLIENT STABLE)
-- ==========================================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

local tool = Instance.new("Tool")
tool.Name = "Divergent Fist"
tool.RequiresHandle = false
tool.Parent = player:WaitForChild("Backpack")

local isEquipped, canAttack = false, true
local originalC0 = nil

-- [MOTOR: HIZ VE GÖRSEL SPIN]
RunService.Heartbeat:Connect(function()
    if isEquipped and player.Character then
        local HRP = player.Character:FindFirstChild("HumanoidRootPart")
        local hum = player.Character:FindFirstChild("Humanoid")
        local rootJoint = HRP and (HRP:FindFirstChild("RootJoint") or (player.Character:FindFirstChild("LowerTorso") and player.Character.LowerTorso:FindFirstChild("RootJoint")))
        
        if not HRP or not hum or not rootJoint then return end
        
        -- 1. HIZ ÇARPANI (Pürüzsüz WalkSpeed)
        if hum.MoveDirection.Magnitude > 0 then
            hum.WalkSpeed = 40
        else
            hum.WalkSpeed = 0
        end
        
        -- 2. SERVER-VISIBLE SPIN (Kamerayı bozmayan yöntem)
        -- Orijinal C0 değerini bir kez kaydediyoruz
        if not originalC0 then originalC0 = rootJoint.C0 end
        
        -- RootJoint'i döndürerek karakterin görselini pervane yapıyoruz
        -- Bu işlem HRP'yi (ve kamerayı) döndürmez ama server'da karakter modelin döner
        rootJoint.C0 = rootJoint.C0 * CFrame.Angles(0, 0, math.rad(60))
        
        -- Fiziksel Fling Koruması
        HRP.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    end
end)

-- [VURUŞ MANTIĞI - SENİN ORİJİNAL KODUN]
tool.Activated:Connect(function()
    if not canAttack or not player.Character then return end
    local HRP = player.Character.HumanoidRootPart
    local target = mouse.Target
    
    if target and target.Parent and target.Parent:FindFirstChild("HumanoidRootPart") then
        local enemyHRP = target.Parent.HumanoidRootPart
        if (HRP.Position - enemyHRP.Position).Magnitude < 10 then
            canAttack = false
            
            enemyHRP.AssemblyLinearVelocity = Vector3.new(0,0,0)
            task.wait(0.12)
            
            local oldCF = HRP.CFrame
            local power = (UserInputService.MouseBehavior == Enum.MouseBehavior.LockCenter) and 12000 or 22000
            
            HRP.CFrame = enemyHRP.CFrame * CFrame.new(0, 0, 0.4)
            HRP.AssemblyLinearVelocity = (HRP.CFrame.LookVector * power) + Vector3.new(0, 8000, 0)
            
            task.wait(0.05)
            HRP.CFrame = oldCF
            HRP.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
            
            task.wait(0.6)
            canAttack = true
        end
    end
end)

-- [EQUIP/UNEQUIP]
tool.Equipped:Connect(function() 
    isEquipped = true 
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = 40
        player.Character.Humanoid.AutoRotate = true -- Kameran özgürce döner
    end
end)

tool.Unequipped:Connect(function() 
    isEquipped = false 
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = 16
        
        -- Resetleme: Karakteri düzelt
        local HRP = player.Character:FindFirstChild("HumanoidRootPart")
        local rootJoint = HRP and (HRP:FindFirstChild("RootJoint") or (player.Character:FindFirstChild("LowerTorso") and player.Character.LowerTorso:FindFirstChild("RootJoint")))
        if rootJoint and originalC0 then
            rootJoint.C0 = originalC0
            originalC0 = nil
        end
    end
end)
